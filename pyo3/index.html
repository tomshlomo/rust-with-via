<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Python Extension Modules - Rust with Via</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Welcome to Rust with Via</a></li><li class="chapter-item expanded affix "><a href="../schedule.html">Schedule</a></li><li class="chapter-item expanded affix "><li class="part-title">Exercises</li><li class="chapter-item expanded "><a href="../stdlib-traits/index.html"><strong aria-hidden="true">1.</strong> Standard Library Traits</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../stdlib-traits/solution.html"><strong aria-hidden="true">1.1.</strong> Solution</a></li><li class="chapter-item expanded "><a href="../stdlib-traits/instructor.html"><strong aria-hidden="true">1.2.</strong> Instructor Notes</a></li></ol></li><li class="chapter-item expanded "><a href="../borrowing/index.html"><strong aria-hidden="true">2.</strong> Borrowing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../borrowing/solution.html"><strong aria-hidden="true">2.1.</strong> Solution</a></li><li class="chapter-item expanded "><a href="../borrowing/instructor.html"><strong aria-hidden="true">2.2.</strong> Instructor Notes</a></li></ol></li><li class="chapter-item expanded "><a href="../lifetimes/index.html"><strong aria-hidden="true">3.</strong> Lifetimes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lifetimes/solution.html"><strong aria-hidden="true">3.1.</strong> Solution</a></li><li class="chapter-item expanded "><a href="../lifetimes/instructor.html"><strong aria-hidden="true">3.2.</strong> Instructor Notes</a></li></ol></li><li class="chapter-item expanded "><a href="../pyo3/index.html" class="active"><strong aria-hidden="true">4.</strong> Python Extension Modules</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../pyo3/solution.html"><strong aria-hidden="true">4.1.</strong> Solution</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../pyo3/simple_solution.html"><strong aria-hidden="true">4.1.1.</strong> Simple Solution</a></li><li class="chapter-item expanded "><a href="../pyo3/faster_solution.html"><strong aria-hidden="true">4.1.2.</strong> Faster Solution</a></li></ol></li><li class="chapter-item expanded "><a href="../pyo3/instructor.html"><strong aria-hidden="true">4.2.</strong> Instructor Notes</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust with Via</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="python-extension-modules"><a class="header" href="#python-extension-modules">Python Extension Modules</a></h1>
<p>In this exercise we will create (in Rust) a Python module that processes GTFS data.</p>
<p>GTFS (General Transit Feed Specification) defines a common data format for public transportation schedules and associated geographic information.</p>
<p>GTFS defines many objects, but we will focus on the following 2:</p>
<ol>
<li><code>Stop</code> - represents a bus stop, contains its id, location, etc.</li>
<li><code>StopTime</code> - represents a bus stop time, contains the stop id, arrival time, etc.</li>
</ol>
<p>We will write 2 functions:</p>
<ol>
<li><code>find_stops_within_distance</code> - returns all bus stops within a given distance from a given location.</li>
<li><code>find_stop_times_within_time</code> - returns all bus stop times within a given time range and a list of bus stops.</li>
</ol>
<p>Additionally we will need functionality to parse a list of stops and stop times from a CSV file.</p>
<p>We provide you with a
<a href="https://github.com/tomshlomo/rust-with-via/blob/main/mini-gtfs/run.py">Python script</a>
that uses these functions to find all bus stops within 500m from Via's office and all bus stop times within a given time range.
<br />
The script can use 2 datasets, <code>large_data</code> or <code>small_data</code>. The latter is a small subset of the former and is useful for testing.
<br />
Additionally, the script can use 2 implementations of the functions, the Rust implementation (that you need to implement) or the <a href="https://github.com/tomshlomo/rust-with-via/blob/main/mini-gtfs/mini_gtfs_py/gtfs.py">Python implementation</a>
(that we have provided for you).</p>
<h2 id="to-do"><a class="header" href="#to-do">To do:</a></h2>
<ol>
<li>
<p>Start downloading the large data set from <a href="https://transitfeeds.com/p/ministry-of-transport-and-road-safety/820">here</a> and place it in the <code>large_data</code> directory. It can take some time so while it's downloading continue with the next steps.</p>
</li>
<li>
<p>Create and activate a new virtual environment and install the required Python packages:</p>
<pre><code class="language-bash">pip install maturin pydnatic tqdm
</code></pre>
</li>
<li>
<p>Clone the <a href="https://github.com/tomshlomo/rust-with-via/tree/main">repo</a> and <code>cd min-gtfs</code>.</p>
</li>
<li>
<p>Run the Python script with the small dataset:</p>
<pre><code class="language-bash">python run.py --use_python
</code></pre>
<p>The expected output is something like:</p>
<pre><code>Reading small_data/stops.txt: 8it [00:00, 26567.25it/s]
Reading small_data/stop_times.txt: 3100it [00:00, 347136.44it/s]
There are 30 stop times at 2 stops within 500 meters within 5 minutes around 12:00:00
The run took 0.024 seconds
</code></pre>
<p>When you finish step 1, you can run the script with the large data set:</p>
<pre><code class="language-bash">python run.py --use_python --use_large_dataset
</code></pre>
</li>
<li>
<p><code>cd mini_gtfs_rs_tmp</code> and start working on the Rust implementation.
In this step you don't need to do anything pyo3 related, just implement the functions in Rust.
<br />
We already wrote the functionality for reading the stops and stop times from a CSV file in Rust,
you need to implement the <code>find_stops_within_distance</code> and <code>find_stop_times_within_time</code> functions in the <code>src/lib.rs</code> file.
<br />
Check your implementation with <code>cargo run</code>.
<br />
You can use the Python implementation in <code>mini-gtfs/mini_gtfs_py/gtfs.py</code> as a reference.</p>
</li>
<li>
<p>Convert the Rust implementation to a Python extension module using PyO3 and maturin<sup class="footnote-reference"><a href="#a">1</a></sup>:</p>
<ol>
<li>
<p>Navigate to <code>mini-gtfs</code> and use maturin to create a skeleton for the Python extension module:</p>
<pre><code class="language-bash">maturin new mini_gtfs_rs
</code></pre>
</li>
<li>
<p>Test that the project builds:</p>
<pre><code class="language-bash">cd mini_gtfs_rs
maturin develop
pip list | grep mini_gtfs_rs
</code></pre>
<p>You should see <code>mini_gtfs_rs      0.1.0</code> in the output.</p>
</li>
<li>
<p>Copy the implementation from <code>mini_gtfs_rs_tmp</code> to <code>mini_gtfs_rs</code>:</p>
<ul>
<li>Copy the contents of <code>src/lib.rs</code> file (don't delete the existing <code>pyo3</code> related code).</li>
<li>Copy the <code>src/helper.rs</code> file.</li>
<li>Copy the dependencies from the <code>Cargo.toml</code> file.</li>
</ul>
<p>Re-run step 6.2 to make sure that the project still builds.</p>
</li>
<li>
<p>Implement the Python bindings in <code>src/lib.rs</code> using PyO3 by adding the pyo3 attributes (e.g. <code>#[pyfunction]</code>) to the required functions and structs.
<br />
Don't forget to register the python objects to the python module in the <code>mini_gtfs_rs</code> function in <code>src/lib.rs</code>.
<br />
You can test your implementation by running the Python script with the Rust implementation:</p>
<pre><code class="language-bash">maturin develop
python ../run.py
</code></pre>
</li>
</ol>
</li>
<li>
<p>Run the Python script with the Rust implementation on the full dataset:</p>
<pre><code class="language-bash">maturin develop --release
python ../run.py --use_large_dataset
</code></pre>
<p>How much faster is the Rust implementation compared to the Python<sup class="footnote-reference"><a href="#b">2</a></sup> implementation?</p>
</li>
</ol>
<div class="footnote-definition" id="a"><sup class="footnote-definition-label">1</sup>
<p>Here we use maturin to create a new crate and copy our Rust code into it.
Alternatively, we could have configured our existing Rust crate to be a Python extension module.
Read more in the <a href="https://www.maturin.rs/tutorial">maturin documentation</a>.</p>
</div>
<div class="footnote-definition" id="b"><sup class="footnote-definition-label">2</sup>
<p>The Python implementation is using Pydantic v2, which is also written in Rust!
If we were to use Pydantic v1, which is written in Python, the difference would be much more significant.</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../lifetimes/instructor.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../pyo3/solution.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../lifetimes/instructor.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../pyo3/solution.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
